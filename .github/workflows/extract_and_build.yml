name: Extract any ZIP and Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo root (for debug)
        run: ls -la

      - name: Find ZIP in repo root
        id: findzip
        run: |
          set -e
          # find first zip in repo root (non-recursive)
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -n 1 || true)
          if [ -z "$ZIP_FILE" ]; then
            echo "no_zip=true" >> $GITHUB_OUTPUT
            echo "No zip found in repo root. Make sure you uploaded your project zip file to the repository root." 
            exit 1
          else
            echo "zip=$ZIP_FILE" >> $GITHUB_OUTPUT
            echo "Found zip: $ZIP_FILE"
          fi

      - name: Install unzip
        if: always()
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Extract ZIP to 'extracted' folder
        run: |
          ZIP="${{ steps.findzip.outputs.zip }}"
          mkdir -p extracted
          unzip -o "$ZIP" -d extracted
          echo "Extracted contents:"
          ls -la extracted | sed -n '1,200p'

      - name: Move extracted files to repo root
        run: |
          # move contents but avoid overwriting .github
          shopt -s dotglob
          for f in extracted/*; do
            if [ -e "$f" ]; then
              fname=$(basename "$f")
              if [ "$fname" = ".github" ]; then
                cp -r "$f" .github_temp || true
              else
                cp -r "$f" .
              fi
            fi
          done
          # if extracted had a .github folder, merge it (so we don't lose workflows)
          if [ -d ".github_temp" ]; then
            mkdir -p .github
            cp -r .github_temp/* .github/
            rm -rf .github_temp
          fi
          echo "After move, repo root:"
          ls -la

      - name: Ensure config.xml exists
        run: |
          if [ ! -f config.xml ]; then
            echo "ERROR: config.xml not found in repo root after extraction."
            ls -la
            exit 1
          else
            echo "Found config.xml"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Cordova
        run: npm install -g cordova

      - name: Add Android platform
        run: cordova platform add android
        env:
          HOME: ${{ runner.temp }}

      - name: Build Release APK
        run: cordova build android --release
        env:
          HOME: ${{ runner.temp }}

      - name: Upload APK artifact (v4)
        uses: actions/upload-artifact@v4
        with:
          name: lambda2d-apk
          path: platforms/android/app/build/outputs/**/*.apk